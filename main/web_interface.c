#include "web_interface.h"
#include "motor_control.h"
#include "esp_log.h"
#include <stdio.h>
#include <string.h>

// ç½‘é¡µç•Œé¢HTMLå†…å®¹
static const char* web_page_html = 
"<!DOCTYPE html>"
"<html><head>"
"<meta charset='UTF-8'>"
"<meta name='viewport' content='width=device-width, initial-scale=1.0'>"
"<title>ç”µæœºå¤šæ¨¡å¼æ§åˆ¶</title>"
"<style>"
"body{font-family:Arial,sans-serif;max-width:700px;margin:30px auto;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}"
".container{background:white;padding:30px;border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,0.3)}"
"h1{color:#333;text-align:center;margin-bottom:30px;font-size:28px}"
".mode-section{margin-bottom:25px;padding:20px;border:2px solid #e0e0e0;border-radius:10px;background:#f9f9f9}"
".mode-title{font-size:18px;font-weight:bold;color:#333;margin-bottom:15px;display:flex;align-items:center}"
".mode-title:before{content:'â—';color:#4CAF50;margin-right:8px;font-size:20px}"
".form-group{margin-bottom:15px;display:flex;align-items:center;gap:10px}"
"label{min-width:100px;font-weight:bold;color:#555}"
"input[type='number'],select{padding:8px 12px;border:2px solid #ddd;border-radius:5px;font-size:14px;flex:1}"
"input[type='number']:focus,select:focus{border-color:#4CAF50;outline:none}"
"input[type='radio']{margin-right:8px}"
".radio-group{display:flex;gap:20px;margin-bottom:20px;justify-content:center}"
".radio-option{display:flex;align-items:center;padding:10px 15px;border:2px solid #ddd;border-radius:8px;cursor:pointer;transition:all 0.3s}"
".radio-option:hover{background:#f0f0f0}"
".radio-option.active{border-color:#4CAF50;background:#e8f5e8}"
".btn{background:#4CAF50;color:white;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-size:14px;margin:3px;transition:all 0.3s}"
".btn:hover{background:#45a049;transform:translateY(-1px)}"
".btn-danger{background:#f44336}"
".btn-danger:hover{background:#d32f2f}"
".btn-warning{background:#ff9800}"
".btn-warning:hover{background:#f57c00}"
".btn-info{background:#2196F3}"
".btn-info:hover{background:#1976D2}"
".btn-restart{background:#ff9800}"
".btn-restart:hover{background:#f57c00}"
".control-panel{display:flex;justify-content:center;gap:10px;margin:20px 0;flex-wrap:wrap}"
".status{margin-top:20px;padding:15px;border-radius:8px;background:#e3f2fd;border-left:4px solid #2196F3}"
".mode-content{display:none}"
".mode-content.active{display:block}"
".unit{color:#888;font-size:12px;margin-left:5px}"
".error-status{padding:2px 6px;border-radius:4px;font-size:12px;font-weight:bold}"
".error-normal{background:#d4edda;color:#155724}"
".error-warning{background:#fff3cd;color:#856404}"
".error-danger{background:#f8d7da;color:#721c24}"
"</style>"
"</head><body>"
"<div class='container'>"
"<h1>âš™ï¸ ç”µæœºå¤šæ¨¡å¼æ§åˆ¶ç³»ç»Ÿ</h1>"

"<div class='radio-group'>"
"<div class='radio-option active' onclick='selectMode(\"velocity\")'>"
"<input type='radio' name='mode' value='velocity' checked id='mode-velocity'>"
"<label for='mode-velocity'>ğŸƒ é€Ÿåº¦æ¨¡å¼</label>"
"</div>"
"<div class='radio-option' onclick='selectMode(\"position\")'>"
"<input type='radio' name='mode' value='position' id='mode-position'>"
"<label for='mode-position'>ğŸ“ ä½ç½®æ¨¡å¼</label>"
"</div>"
"<div class='radio-option' onclick='selectMode(\"torque\")'>"
"<input type='radio' name='mode' value='torque' id='mode-torque'>"
"<label for='mode-torque'>ğŸ’ª åŠ›çŸ©æ¨¡å¼</label>"
"</div>"
"</div>"

"<div id='velocity-content' class='mode-content active'>"
"<div class='mode-section'>"
"<div class='mode-title'>é€Ÿåº¦æ§åˆ¶</div>"
"<div class='form-group'>"
"<label>ç›®æ ‡é€Ÿåº¦:</label>"
"<input type='number' id='velocity' step='0.1' placeholder='è¯·è¾“å…¥é€Ÿåº¦å€¼'>"
"<span class='unit'>r/s</span>"
"<button class='btn' onclick='setVelocity()'>è®¾ç½®é€Ÿåº¦</button>"
"</div>"
"</div>"
"</div>"

"<div id='position-content' class='mode-content'>"
"<div class='mode-section'>"
"<div class='mode-title'>ä½ç½®æ§åˆ¶</div>"
"<div class='form-group'>"
"<label>ç›®æ ‡ä½ç½®:</label>"
"<input type='number' id='position' step='0.1' placeholder='è¯·è¾“å…¥ä½ç½®å€¼'>"
"<span class='unit'>ä½ç½®å€¼</span>"
"<button class='btn' onclick='setPosition()'>è®¾ç½®ä½ç½®</button>"
"</div>"
"<div class='form-group'>"
"<label>è§’åº¦è¾“å…¥:</label>"
"<input type='number' id='angle' step='0.1' placeholder='è¯·è¾“å…¥è§’åº¦å€¼'>"
"<span class='unit'>åº¦</span>"
"<button class='btn' onclick='setAngle()'>è®¾ç½®è§’åº¦</button>"
"</div>"
"</div>"
"</div>"

"<div id='torque-content' class='mode-content'>"
"<div class='mode-section'>"
"<div class='mode-title'>åŠ›çŸ©æ§åˆ¶</div>"
"<div class='form-group'>"
"<label>ç›®æ ‡åŠ›çŸ©:</label>"
"<input type='number' id='torque' step='0.01' placeholder='è¯·è¾“å…¥åŠ›çŸ©å€¼'>"
"<span class='unit'>Nm</span>"
"<button class='btn' onclick='setTorque()'>è®¾ç½®åŠ›çŸ©</button>"
"</div>"
"</div>"
"</div>"

"<div class='control-panel'>"
"<button class='btn btn-info' onclick='enableMotor()'>ğŸ”‹ ä½¿èƒ½ç”µæœº</button>"
"<button class='btn btn-danger' onclick='disableMotor()'>ğŸ”Œ å¤±èƒ½ç”µæœº</button>"
"<button class='btn btn-warning' onclick='clearErrors()'>ğŸ”§ æ¸…é™¤é”™è¯¯</button>"
"<button class='btn btn-restart' onclick='restartMotor()'>ğŸ”„ é‡å¯ç”µæœº</button>"
"</div>"

"<div class='mode-section'>"
"<div class='mode-title'>â±ï¸ çŠ¶æ€æŸ¥è¯¢æ§åˆ¶</div>"
"<div class='form-group'>"
"<label>æŸ¥è¯¢é¢‘ç‡:</label>"
"<input type='number' id='query-frequency' min='1' max='100' step='0.5' value='1.0' placeholder='1.0-100.0'>"
"<span class='unit'>Hz</span>"
"<button class='btn btn-info' onclick='setQueryFrequency()'>è®¾ç½®é¢‘ç‡</button>"
"</div>"
"<div class='form-group'>"
"<button class='btn btn-info' id='query-toggle' onclick='toggleAutoQuery()'>ğŸ”„ å¯åŠ¨è‡ªåŠ¨æŸ¥è¯¢</button>"
"<span id='query-status' style='margin-left:10px;color:#666'>è‡ªåŠ¨æŸ¥è¯¢å·²åœæ­¢</span>"
"</div>"
"</div>"

"<div class='status'>"
"<strong>å½“å‰çŠ¶æ€:</strong> <span id='status'>ç³»ç»Ÿå°±ç»ªï¼Œè¯·é€‰æ‹©å·¥ä½œæ¨¡å¼</span>"
"</div>"

"<div class='mode-section'>"
"<div class='mode-title'>ğŸ“Š ç”µæœºå®æ—¶çŠ¶æ€</div>"
"<div id='motor-status'>"
"<div style='display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px'>"
"<div style='padding:10px;background:#f0f8ff;border-radius:8px'>"
"<strong>ğŸ”¥ åŠ›çŸ©åé¦ˆ</strong><br>"
"ç›®æ ‡åŠ›çŸ©: <span id='target-torque'>--</span> Nm<br>"
"å½“å‰åŠ›çŸ©: <span id='current-torque'>--</span> Nm"
"</div>"
"<div style='padding:10px;background:#f0fff0;border-radius:8px'>"
"<strong>âš¡ åŠŸç‡åé¦ˆ</strong><br>"
"ç”µåŠŸç‡: <span id='electrical-power'>--</span> W<br>"
"æœºæ¢°åŠŸç‡: <span id='mechanical-power'>--</span> W"
"</div>"
"</div>"
"<div style='display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px'>"
"<div style='padding:10px;background:#fffaf0;border-radius:8px'>"
"<strong>ğŸ“ ä½ç½®è½¬é€Ÿ</strong><br>"
"ä½ç½®: <span id='position-display'>--</span> è½¬<br>"
"è½¬é€Ÿ: <span id='velocity-display'>--</span> è½¬/s"
"</div>"
"<div style='padding:10px;background:#fff0f5;border-radius:8px'>"
"<strong>ğŸ”¢ ç¼–ç å™¨</strong><br>"
"å¤šåœˆè®¡æ•°: <span id='shadow-count'>--</span><br>"
"å•åœˆè®¡æ•°: <span id='count-in-cpr'>--</span>"
"</div>"
"</div>"
"<div style='padding:10px;background:#f5f5f5;border-radius:8px'>"
"<strong>â— å¼‚å¸¸çŠ¶æ€</strong><br>"
"ç”µæœº: <span id='motor-error' class='error-status'>æ­£å¸¸</span> | "
"ç¼–ç å™¨: <span id='encoder-error' class='error-status'>æ­£å¸¸</span> | "
"æ§åˆ¶å™¨: <span id='controller-error' class='error-status'>æ­£å¸¸</span> | "
"ç³»ç»Ÿ: <span id='system-error' class='error-status'>æ­£å¸¸</span>"
"</div>"
"</div>"
"</div>"
"</div>"

"<script>"
"let currentMode='velocity';"
"function selectMode(mode){"
"currentMode=mode;"
"document.querySelectorAll('.mode-content').forEach(el=>el.classList.remove('active'));"
"document.querySelectorAll('.radio-option').forEach(el=>el.classList.remove('active'));"
"document.getElementById(mode+'-content').classList.add('active');"
"event.currentTarget.classList.add('active');"
"document.getElementById('mode-'+mode).checked=true;"
"fetch('/set_mode?mode='+mode).then(r=>r.text()).then(d=>{"
"document.getElementById('status').textContent='æ¨¡å¼åˆ‡æ¢: '+getModeName(mode)+' | '+d;"
"}).catch(e=>console.log('æ¨¡å¼åˆ‡æ¢å¤±è´¥: '+e));"
"}"
"function getModeName(mode){"
"const names={'velocity':'é€Ÿåº¦æ¨¡å¼','position':'ä½ç½®æ¨¡å¼','torque':'åŠ›çŸ©æ¨¡å¼'};"
"return names[mode]||mode;"
"}"
"function setVelocity(){"
"let vel=document.getElementById('velocity').value;"
"if(vel===''){alert('è¯·è¾“å…¥é€Ÿåº¦å€¼');return;}"
"fetch('/set_velocity?value='+vel).then(r=>r.text()).then(d=>{"
"document.getElementById('status').textContent='é€Ÿåº¦è®¾ç½®: '+vel+' r/s | '+d;"
"}).catch(e=>alert('è®¾ç½®å¤±è´¥: '+e));"
"}"
"function setPosition(){"
"let pos=document.getElementById('position').value;"
"if(pos===''){alert('è¯·è¾“å…¥ä½ç½®å€¼');return;}"
"fetch('/set_position?value='+pos).then(r=>r.text()).then(d=>{"
"document.getElementById('status').textContent='ä½ç½®è®¾ç½®: '+pos+' | '+d;"
"}).catch(e=>alert('è®¾ç½®å¤±è´¥: '+e));"
"}"
"function setAngle(){"
"let angle=document.getElementById('angle').value;"
"if(angle===''){alert('è¯·è¾“å…¥è§’åº¦å€¼');return;}"
"fetch('/set_angle?value='+angle).then(r=>r.text()).then(d=>{"
"document.getElementById('status').textContent='è§’åº¦è®¾ç½®: '+angle+'Â° | '+d;"
"}).catch(e=>alert('è®¾ç½®å¤±è´¥: '+e));"
"}"
"function setTorque(){"
"let torque=document.getElementById('torque').value;"
"if(torque===''){alert('è¯·è¾“å…¥åŠ›çŸ©å€¼');return;}"
"fetch('/set_torque?value='+torque).then(r=>r.text()).then(d=>{"
"document.getElementById('status').textContent='åŠ›çŸ©è®¾ç½®: '+torque+' Nm | '+d;"
"}).catch(e=>alert('è®¾ç½®å¤±è´¥: '+e));"
"}"
"function enableMotor(){"
"fetch('/enable').then(r=>r.text()).then(d=>{"
"document.getElementById('status').textContent='ç”µæœºå·²ä½¿èƒ½ | '+d;"
"}).catch(e=>alert('æ“ä½œå¤±è´¥: '+e));"
"}"
"function disableMotor(){"
"fetch('/disable').then(r=>r.text()).then(d=>{"
"document.getElementById('status').textContent='ç”µæœºå·²å¤±èƒ½ | '+d;"
"}).catch(e=>alert('æ“ä½œå¤±è´¥: '+e));"
"}"
"function clearErrors(){"
"fetch('/clear').then(r=>r.text()).then(d=>{"
"document.getElementById('status').textContent='é”™è¯¯å·²æ¸…é™¤ | '+d;"
"}).catch(e=>alert('æ“ä½œå¤±è´¥: '+e));"
"}"
"function restartMotor(){"
"fetch('/restart').then(r=>r.text()).then(d=>{"
"document.getElementById('status').textContent='ç”µæœºå·²é‡å¯ | '+d;"
"}).catch(e=>alert('æ“ä½œå¤±è´¥: '+e));"
"}"

"function updateMotorStatus(){"
"fetch('/api/motor_status').then(r=>r.json()).then(data=>{"
"document.getElementById('target-torque').textContent=data.target_torque.toFixed(3)||'--';"
"document.getElementById('current-torque').textContent=data.current_torque.toFixed(3)||'--';"
"document.getElementById('electrical-power').textContent=data.electrical_power.toFixed(2)||'--';"
"document.getElementById('mechanical-power').textContent=data.mechanical_power.toFixed(2)||'--';"
"document.getElementById('position-display').textContent=data.position.toFixed(2)||'--';"
"document.getElementById('velocity-display').textContent=data.velocity.toFixed(3)||'--';"
"document.getElementById('shadow-count').textContent=data.shadow_count||'--';"
"document.getElementById('count-in-cpr').textContent=data.count_in_cpr||'--';"

"updateErrorStatus('motor-error',data.motor_error,data.motor_error_desc);"
"updateErrorStatus('encoder-error',data.encoder_error,data.encoder_error_desc);"
"updateErrorStatus('controller-error',data.controller_error,data.controller_error_desc);"
"updateErrorStatus('system-error',data.system_error,data.system_error_desc);"
"}).catch(e=>console.log('çŠ¶æ€æ›´æ–°å¤±è´¥:',e));"
"}"

"function updateErrorStatus(id,code,desc){"
"let elem=document.getElementById(id);"
"elem.className='error-status '+(code?'error-danger':'error-normal');"
"elem.textContent=desc||'æ­£å¸¸';"
"}"

"let autoQueryRunning=false;"
"function setQueryFrequency(){"
"let freq=document.getElementById('query-frequency').value;"
"if(freq===''||freq<1||freq>100){alert('è¯·è¾“å…¥æœ‰æ•ˆé¢‘ç‡å€¼(1.0-100.0Hz)');return;}"
"fetch('/api/set_query_frequency?freq='+freq).then(r=>r.text()).then(d=>{"
"document.getElementById('status').textContent='æŸ¥è¯¢é¢‘ç‡è®¾ç½®: '+freq+' Hz | '+d;"
"}).catch(e=>alert('è®¾ç½®å¤±è´¥: '+e));"
"}"

"function toggleAutoQuery(){"
"let btn=document.getElementById('query-toggle');"
"let status=document.getElementById('query-status');"
"if(autoQueryRunning){"
"fetch('/api/stop_query').then(r=>r.text()).then(d=>{"
"btn.textContent='ğŸ”„ å¯åŠ¨è‡ªåŠ¨æŸ¥è¯¢';"
"btn.className='btn btn-info';"
"status.textContent='è‡ªåŠ¨æŸ¥è¯¢å·²åœæ­¢';"
"status.style.color='#666';"
"autoQueryRunning=false;"
"document.getElementById('status').textContent='è‡ªåŠ¨æŸ¥è¯¢å·²åœæ­¢ | '+d;"
"}).catch(e=>alert('åœæ­¢å¤±è´¥: '+e));"
"}else{"
"fetch('/api/start_query').then(r=>r.text()).then(d=>{"
"btn.textContent='â¸ï¸ åœæ­¢è‡ªåŠ¨æŸ¥è¯¢';"
"btn.className='btn btn-warning';"
"status.textContent='è‡ªåŠ¨æŸ¥è¯¢è¿è¡Œä¸­';"
"status.style.color='#4CAF50';"
"autoQueryRunning=true;"
"document.getElementById('status').textContent='è‡ªåŠ¨æŸ¥è¯¢å·²å¯åŠ¨ | '+d;"
"}).catch(e=>alert('å¯åŠ¨å¤±è´¥: '+e));"
"}}"

"setInterval(updateMotorStatus,1000);"
"updateMotorStatus();"
"</script>"
"</body></html>";

// è°ƒè¯•é¡µé¢HTMLå†…å®¹
static const char* debug_page_html = 
"<!DOCTYPE html>"
"<html><head>"
"<meta charset='UTF-8'>"
"<meta name='viewport' content='width=device-width, initial-scale=1.0'>"
"<title>ç”µæœºè°ƒè¯•å·¥å…·</title>"
"<style>"
"body{font-family:Arial,sans-serif;max-width:800px;margin:30px auto;padding:20px;background:linear-gradient(135deg,#ff7e5f 0%,#feb47b 100%)}"
".container{background:white;padding:30px;border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,0.3)}"
"h1{color:#333;text-align:center;margin-bottom:30px;font-size:28px}"
".debug-section{margin-bottom:25px;padding:20px;border:2px solid #e0e0e0;border-radius:10px;background:#f9f9f9}"
".section-title{font-size:18px;font-weight:bold;color:#333;margin-bottom:15px;display:flex;align-items:center}"
".section-title:before{content:'ğŸ”§';margin-right:8px;font-size:20px}"
".btn-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}"
".btn{background:#4CAF50;color:white;padding:12px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;transition:all 0.3s;text-align:center}"
".btn:hover{background:#45a049;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.2)}"
".btn-restart{background:#ff9800}"
".btn-restart:hover{background:#f57c00}"
".btn-query{background:#2196F3}"
".btn-query:hover{background:#1976D2}"
".exception-group{display:flex;align-items:center;gap:10px;margin-bottom:15px}"
"select{padding:8px 12px;border:2px solid #ddd;border-radius:5px;font-size:14px}"
".status{margin-top:20px;padding:15px;border-radius:8px;background:#e8f5e8;border-left:4px solid #4CAF50;font-family:monospace;max-height:200px;overflow-y:auto}"
".nav-link{display:inline-block;margin:10px 0;color:#2196F3;text-decoration:none;font-weight:bold}"
".nav-link:hover{text-decoration:underline}"
"</style>"
"</head><body>"
"<div class='container'>"
"<h1>ğŸ”§ ç”µæœºè°ƒè¯•å·¥å…·</h1>"
"<a href='/' class='nav-link'>â† è¿”å›ä¸»æ§åˆ¶é¡µé¢</a>"

"<div class='debug-section'>"
"<div class='section-title'>ç”µæœºæ§åˆ¶æŒ‡ä»¤</div>"
"<div class='btn-grid'>"
"<button class='btn btn-restart' onclick='restartMotor()'>ğŸ”„ é‡å¯ç”µæœº</button>"
"</div>"
"</div>"

"<div class='debug-section'>"
"<div class='section-title'>ç”µæœºçŠ¶æ€æŸ¥è¯¢</div>"
"<div class='btn-grid'>"
"<button class='btn btn-query' onclick='queryTorque()'>ğŸ’ª æŸ¥è¯¢åŠ›çŸ©</button>"
"<button class='btn btn-query' onclick='queryPower()'>âš¡ æŸ¥è¯¢åŠŸç‡</button>"
"<button class='btn btn-query' onclick='queryEncoder()'>ğŸ”¢ æŸ¥è¯¢ç¼–ç å™¨</button>"
"<button class='btn btn-query' onclick='queryPosSpeed()'>ğŸ“ æŸ¥è¯¢ä½ç½®è½¬é€Ÿ</button>"
"</div>"
"</div>"

"<div class='debug-section'>"
"<div class='section-title'>å¼‚å¸¸çŠ¶æ€æŸ¥è¯¢</div>"
"<div class='exception-group'>"
"<select id='exceptionType'>"
"<option value='0'>ç”µæœºå¼‚å¸¸</option>"
"<option value='1'>ç¼–ç å™¨å¼‚å¸¸</option>"
"<option value='3'>æ§åˆ¶å™¨å¼‚å¸¸</option>"
"<option value='4'>ç³»ç»Ÿå¼‚å¸¸</option>"
"</select>"
"<button class='btn btn-query' onclick='queryException()'>âŒ æŸ¥è¯¢å¼‚å¸¸</button>"
"</div>"
"</div>"

"<div class='status' id='debugStatus'>"
"è°ƒè¯•å·¥å…·å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®å‘é€CANæŒ‡ä»¤æŸ¥è¯¢<br>"
"æ³¨æ„ï¼šæŸ¥è¯¢ç»“æœå°†é€šè¿‡ä¸²å£ç›‘è§†å™¨æ˜¾ç¤ºï¼Œè¯·æŸ¥çœ‹ESP32ä¸²å£è¾“å‡º"
"</div>"
"</div>"

"<script>"
"function restartMotor(){"
"fetch('/debug/restart').then(r=>r.text()).then(d=>{"
"addStatus('é‡å¯ç”µæœºæŒ‡ä»¤å·²å‘é€ | '+d);"
"}).catch(e=>addStatus('é‡å¯å¤±è´¥: '+e));"
"}"
"function queryTorque(){"
"fetch('/debug/query_torque').then(r=>r.text()).then(d=>{"
"addStatus('æŸ¥è¯¢åŠ›çŸ©æŒ‡ä»¤å·²å‘é€ | '+d);"
"}).catch(e=>addStatus('æŸ¥è¯¢å¤±è´¥: '+e));"
"}"
"function queryPower(){"
"fetch('/debug/query_power').then(r=>r.text()).then(d=>{"
"addStatus('æŸ¥è¯¢åŠŸç‡æŒ‡ä»¤å·²å‘é€ | '+d);"
"}).catch(e=>addStatus('æŸ¥è¯¢å¤±è´¥: '+e));"
"}"
"function queryEncoder(){"
"fetch('/debug/query_encoder').then(r=>r.text()).then(d=>{"
"addStatus('æŸ¥è¯¢ç¼–ç å™¨æŒ‡ä»¤å·²å‘é€ | '+d);"
"}).catch(e=>addStatus('æŸ¥è¯¢å¤±è´¥: '+e));"
"}"
"function queryPosSpeed(){"
"fetch('/debug/query_pos_speed').then(r=>r.text()).then(d=>{"
"addStatus('æŸ¥è¯¢ä½ç½®è½¬é€ŸæŒ‡ä»¤å·²å‘é€ | '+d);"
"}).catch(e=>addStatus('æŸ¥è¯¢å¤±è´¥: '+e));"
"}"
"function queryException(){"
"let type=document.getElementById('exceptionType').value;"
"fetch('/debug/query_exception?type='+type).then(r=>r.text()).then(d=>{"
"addStatus('æŸ¥è¯¢å¼‚å¸¸æŒ‡ä»¤å·²å‘é€(ç±»å‹:'+type+') | '+d);"
"}).catch(e=>addStatus('æŸ¥è¯¢å¤±è´¥: '+e));"
"}"
"function addStatus(msg){"
"let status=document.getElementById('debugStatus');"
"let time=new Date().toLocaleTimeString();"
"status.innerHTML+='<br>['+time+'] '+msg;"
"status.scrollTop=status.scrollHeight;"
"}"
"</script>"
"</body></html>";

const char* get_web_page_html(void) {
    return web_page_html;
}

const char* get_debug_page_html(void) {
    return debug_page_html;
}

// å…¨å±€JSONç¼“å†²åŒº
static char motor_status_json_buffer[1024];

const char* get_motor_status_json(void) {
    motor_status_t *status = get_motor_status();
    if (!status) {
        strcpy(motor_status_json_buffer, "{\"error\":\"çŠ¶æ€è·å–å¤±è´¥\"}");
        return motor_status_json_buffer;
    }
    
    // è·å–å¼‚å¸¸æè¿°
    const char *motor_error_desc = get_error_description(status->motor_error, 0);
    const char *encoder_error_desc = get_error_description(status->encoder_error, 1);
    const char *controller_error_desc = get_error_description(status->controller_error, 3);
    const char *system_error_desc = get_error_description(status->system_error, 4);
    
    snprintf(motor_status_json_buffer, sizeof(motor_status_json_buffer),
        "{"
        "\"target_torque\":%.3f,"
        "\"current_torque\":%.3f,"
        "\"electrical_power\":%.2f,"
        "\"mechanical_power\":%.2f,"
        "\"position\":%.2f,"
        "\"velocity\":%.3f,"
        "\"shadow_count\":%ld,"
        "\"count_in_cpr\":%ld,"
        "\"motor_error\":%lu,"
        "\"encoder_error\":%lu,"
        "\"controller_error\":%lu,"
        "\"system_error\":%lu,"
        "\"motor_error_desc\":\"%s\","
        "\"encoder_error_desc\":\"%s\","
        "\"controller_error_desc\":\"%s\","
        "\"system_error_desc\":\"%s\","
        "\"data_valid\":%s,"
        "\"last_update_time\":%lu"
        "}",
        status->target_torque,
        status->current_torque,
        status->electrical_power,
        status->mechanical_power,
        status->position,
        status->velocity,
        (long)status->shadow_count,
        (long)status->count_in_cpr,
        (unsigned long)status->motor_error,
        (unsigned long)status->encoder_error,
        (unsigned long)status->controller_error,
        (unsigned long)status->system_error,
        motor_error_desc,
        encoder_error_desc,
        controller_error_desc,
        system_error_desc,
        status->data_valid ? "true" : "false",
        (unsigned long)status->last_update_time
    );
    
    return motor_status_json_buffer;
}